<!DOCTYPE html>
<html>

<head>
    <title>ResolverV4</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
    <style type="text/css">
        #status {
            width: 300px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #progress {
            height: 100%;
            background-color: #4caf50;
        }
    </style>
</head>

<body>
    <div class="ui container">
        <br>
        <h1 class="ui dividing header">Resolver V4</h1>
        <div class="ui message">
            <p>Enter a list of IP addresses or Drag and Drop a text file containing IP addresses:</p>
        </div>

        <div class="ui container">
            <div class="ui three column grid">
                <div class="column">
                    <form>
                        <label for="apiKey">IPinfo API Key:</label>
                        <input type="text" id="apiKey" ><br><br>
                        <textarea id="ipList" rows="10" cols="50"></textarea><br>
                        <label for="removeRFC1918">Remove RFC1918 addresses?</label>
                        <input type="checkbox" id="removeRFC1918" name="removeRFC1918"><br><br>
                        <input type="button" value="Lookup" onclick="lookup()"><br>
                        <input type="button" value="Export to CSV" onclick="exportToCsv()"> <br>
                        <div id="status"></div>
                    </form>
                </div>
                <div class="column">
                    <h3>Country Distribution</h3>
                    <canvas id="countryChart"></canvas>
                </div>
                <div class="column">
                    <h3>Registrar Distribution</h3>
                    <canvas id="registrarChart"></canvas>
                </div>
            </div>
        </div>

        <br>

        <table class="ui celled table" id="resultsTable">
            <tr>
                <th>IP Address</th>
                <th>Registrar</th>
                <th>Country</th>
            </tr>
        </table>
    </div>

    <script>
        // Add a drag and drop event listener to the textarea
        document.getElementById("ipList").addEventListener("drop", function (event) {
            // Prevent the default behavior (open as link for some elements)
            event.preventDefault();

            // Get the file
            var file = event.dataTransfer.files[0];

            // Read the file and display the contents in the textarea
            var reader = new FileReader();
            reader.onload = function () {
                document.getElementById("ipList").value = this.result;
            };
            reader.readAsText(file);
        });

            async function lookup() {
                // Reset the progress variables
                total = 0;
                current = 0;

                // Get the API key from the input field
                const apiKey = document.getElementById("apiKey").value;

                // Get the list of IP addresses from the textarea
                var ipList = document.getElementById("ipList").value;

                // Split the list into an array of individual IP addresses
                var ipArray = ipList.split("\n");

                total = ipArray.length;

                // Get the Remove RFC1918 checkbox value
                const removeRFC1918 = document.getElementById("removeRFC1918").checked;

                // Create objects to store counts of countries and registrars
                const countryCounts = {};
                const registrarCounts = {};

                // Loop through the array of IP addresses
                for (var i = 0; i < ipArray.length; i++) {
                    // Remove leading and trailing whitespace from the IP address
                    var ip = ipArray[i].trim();

                    // Check if the IP address is an RFC1918 address
                    if (removeRFC1918 && isRFC1918(ip)) {
                        // Update the progress bar
                        current++;
                        updateProgressBar();
                        continue;
                    }

                    try {
                        // Make a GET request to the ipinfo.io API to get the whois information for the IP address
                        const response = await fetch("https://ipinfo.io/" + ip + "?token=" + apiKey);

                        if (response.ok) {
                            // Parse the response from the API
                            const whois = await response.json();

                            // Get the IP, registrar, and country from the response
                            var ip = whois.ip;
                            var registrar = whois.org;
                            var country = whois.country;

                            // Add a row to the results table with the IP, registrar, and country
                            var table = document.getElementById("resultsTable");
                            var row = table.insertRow(-1);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            cell1.innerHTML = ip;
                            cell2.innerHTML = registrar;
                            cell3.innerHTML = country;

                            // Update the progress bar
                            current++;
                            updateProgressBar();

                            // Update counts of countries and registrars
                            if (country in countryCounts) {
                                countryCounts[country]++;
                            } else {
                                countryCounts[country] = 1;
                            }

                            if (registrar in registrarCounts) {
                                registrarCounts[registrar]++;
                            } else {
                                registrarCounts[registrar] = 1;
                            }

                            // Update the charts
                            updateCountryChart(countryCounts);
                            updateRegistrarChart(registrarCounts);
                        } else {
                            console.error("Error fetching data: ", response.status, response.statusText);
                        }
                    } catch (error) {
                        console.error("Error during fetch: ", error);
                    }
                }
            }

            function isRFC1918(ip) {
                const ipv4Regex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
                if (!ipv4Regex.test(ip)) {
                    return false;
                }

                const [a, b, c] = ip.split(".").map(Number);
                return (
                    (a === 10) ||
                    (a === 172 && (b >= 16 && b <= 31)) ||
                    (a === 192 && b === 168)
                );
            }

        function updateProgressBar() {
            // Update the status bar
            document.getElementById("status").innerHTML = "Looked up " + current + " of " + total + " IP addresses";

            // Check if all IP addresses have been looked up
            if (current == total) {
                document.getElementById("status").innerHTML = "Lookup complete";
            }
        }

        function updateCountryChart(data) {
            const ctx = document.getElementById('countryChart').getContext('2d');
            if (window.countryPieChart) {
                window.countryPieChart.destroy();
            }
            window.countryPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: generateColors(Object.keys(data).length)
                    }]
                }
            });
        }

        function updateRegistrarChart(data) {
            const ctx = document.getElementById('registrarChart').getContext('2d');
                if (window.registrarPieChart) {
                window.registrarPieChart.destroy();
            }
            window.registrarPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: generateColors(Object.keys(data).length)
                    }]
                }
            });
        }

        function generateColors(numColors) {
            const colors = [];
            for (let i = 0; i < numColors; i++) {
                colors.push('#' + Math.floor(Math.random() * 16777215).toString(16));
            }
            return colors;
        }

        function exportToCsv() {
            // Get the results table
            var table = document.getElementById("resultsTable");

            // Build the CSV data as a string
            var csvData = "";
            for (var i = 0; i < table.rows.length; i++) {
                var row = table.rows[i];
                for (var j = 0; j < row.cells.length; j++) {
                    csvData += row.cells[j].innerHTML;
                    if (j < row.cells.length - 1) {
                        csvData += ",";
                    }
                }
                csvData += "\n";
            }

            // Download the CSV file
            var link = document.createElement("a");
            link.download = "whois.csv";
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csvData);
            link.click();
        }
    </script>
</body>

</html>
